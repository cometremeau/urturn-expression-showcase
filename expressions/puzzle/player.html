<div style="width : 100%; margin : 0px; padding : 0px;" id='container'>
<canvas id='c' width='640' height='640' style='width:100%'> 

</canvas>
</div>
<div id='scores'>

  <div style='width : 25%; background-color : #dadada; color : #888' class='bottomButton'>Help</div>
  <div style='width : 60%; background-color : #b5061b; color : #fafafa' class='bottomButton' onclick='restart()'>Restart</div>  
  <div style='width : 10%; background-color : #fafafa;' class='bottomButton'><span id='uscore'>0</span> </div>

</div>


<div id='highscores' style='display : none'>

  <div style='width : 60%; background-color : #b5061b; color : #fafafa' class='bottomButtonr' onclick='restart()'>Restart</div>  
  <div style='width : 35%; background-color : #fafafa;' class='bottomButtonr'> More </div>

</div>

<div style='display : none; width : 80%; position : absolute; top:10px; left: 10%;' class='box' id='hs'>
  <table>
    <thead>
      <tr>
        <th>
          Rank
        </th>
        <th>
          Name
        </th>
        <th>
          Score
        </th>
      </tr>
    </thead>
    <tbody id='others'>

    </tbody>
  </table>
</div>

<script type="text/javascript">
  var canvas = document.getElementById('c');
  var ctx = canvas.getContext('2d');
  var WIDTH = 640;
  var HEIGHT = 640;
  var MAP = [];
  var TARGET_COLOR = null;
  var NEW_COLOR = null;
  var SCORE = 0;
  var HIGH_SCORES = null;
  var OTHERS_HIGHSCORES = null;
  var userHighScore = 0;
  var GAME_OVER = 0;
  var post = null;
  var USERNAME = '';
  var AVATAR = '';
  var PARTICLES = [];

  var PAINT = document.createElement('image');
  PAINT.src = 'assets/paint.png'

  // var SUCCESS_SOUND = new Audio('assets/success.wav');
  // SUCCESS_SOUND.loop = false;

  // Bootstrap you expression editor
  UT.Expression.ready(function(exp){
    post = exp;
    post.resize(post.node.offsetWidth + 55);
    MAP = JSON.parse(post.storage.map);
    HIGH_SCORES = post.collection('scores');
    userHighScore = HIGH_SCORES.getUserItem();
    HIGH_SCORES.find(otherScoresCallback);
    if (userHighScore) {
      renderHighScores();
    }
    renderGame();
    post.users('current', function(user){
      USERNAME = user.username;
      AVATAR = user.avatar();
    })
  });

  function play() {
    GAME_OVER = 0;
    SCORE = 0;
    MAP = JSON.parse(post.storage.map);
    renderGame();
    document.getElementById('hs').style.display = 'none';
    document.getElementById('highscores').style.display = 'none';
    document.getElementById('scores').style.display = 'block';
  }

  function restart() {
    if (!GAME_OVER)
      play();
  }


  function otherScoresCallback(items) {
    OTHERS_HIGHSCORES = items;
    OTHERS_HIGHSCORES.sort(function (a, b) {
      if (a.score < b.score) {
        return -1;
      }
      return 1;
    });
    renderOtherHighScore();
    computeUserPosition();
  }


  function renderOtherHighScore() {
    if (!OTHERS_HIGHSCORES) {
     return;
    }

    var others = document.getElementById('others');
    others.innerHTML = '';
    if (OTHERS_HIGHSCORES) {
      var i = 0;
      while (i < OTHERS_HIGHSCORES.length) {
        var tr = document.createElement('tr');
        tr.innerHTML = '<td>' + (i + 1) 
        +  '</td><td>'
        + '@' + OTHERS_HIGHSCORES[i].username
        +  '</td><td>'
        + OTHERS_HIGHSCORES[i].score
        +  '</td>';
        others.appendChild(tr);
        ++i;
      }
    }
  }

  function drawHighScores() {
    var hs = document.getElementById('hs');
    hs.style.display = 'block';
    document.getElementById('scores').style.display = 'none';
    document.getElementById('highscores').style.display = 'block';
    GAME_OVER = 1;
    renderOtherHighScore();
  }

  canvas.addEventListener('mousedown', mouseDown);
  canvas.addEventListener('mouseup', mouseUp);
  canvas.addEventListener('touchstart', touchstart);
  canvas.addEventListener('touchend', touchend);

  function touchstart(event){
    var e = event.touches[0];
    mouseDown(e);
    event.preventDefault();
    event.stopPropagation();
  }

  function touchend(event){
    var e = event.touches[0];
    mouseUp(e);
    event.preventDefault();
    event.stopPropagation();
  }

  var MOUSE = {
  	x : 0,
  	y : 0
  }

  var SELECTED = {
    x : 0,
    y : 0,
    d : 0
  }

  function mouseDown(event) {
    if (GAME_OVER) {
      return;
    }
    var x = (event.clientX / (canvas.offsetWidth / WIDTH)) / 80 | 0;
    var y = (event.clientY / (canvas.offsetHeight / HEIGHT)) / 80 | 0;

    if (SELECTED.d) {
      if (Math.abs(MOUSE.x - x) + Math.abs(MOUSE.y  - y) === 1) {
        contaminate(x,y, MOUSE.x, MOUSE.y);
      }
      SELECTED.d = 0;
    }
    else {
      MOUSE.x = x;
      MOUSE.y = y;
      SELECTED.x = x;
      SELECTED.y = y;
      SELECTED.d = 1; 
    }
    // GUI!
    renderGame();
  } 

  function mouseUp(event) {
    if (GAME_OVER) {
      return;
    }
    if (!SELECTED.d) {
      return;
    }
    var x = (event.clientX / (canvas.offsetWidth / WIDTH)) / 80 | 0;
    var y = (event.clientY / (canvas.offsetHeight / HEIGHT)) / 80 | 0;	
    if (x == SELECTED.x && y == SELECTED.y) {
      return
    }
    SELECTED.d = 0;
  	// If move is valid
    if (Math.abs(MOUSE.x - x) + Math.abs(MOUSE.y  - y) === 1) {
    	contaminate(x,y, MOUSE.x, MOUSE.y);
    }	
    renderGame();
  }

  function renderGame() {
  	renderMap();
  	renderGUI();
  }

  function renderMap()
  {
  	var i = 0;
  	while (i < 8) {
  		var j = 0;
  		while (j < 8) {
  			ctx.fillStyle = MAP[i][j];
  			ctx.fillRect(i * 80, j * 80, 80, 80)
  			++j;
  		}
  		++i;
  	}
  }

  function renderGameOver() {
    renderHighScores();
  }


  var USER_POSITION = -1;
  function  computeUserPosition() {
    if (!userHighScore || !OTHERS_HIGHSCORES) {
      return;
    }
    var i = 0;
    USER_POSITION = OTHERS_HIGHSCORES.length;
    while (i < OTHERS_HIGHSCORES.length) {
      if (OTHERS_HIGHSCORES[i].score > userHighScore) {
        USER_POSITION = i;
      }
      ++i;
    }
  }

  function renderHighScores() {
    if (userHighScore) {
      if (userHighScore.score > SCORE) {
        setHighScore();
        computeUserPosition();
      }
    }
    else {
      setHighScore();
    }
    if (USER_POSITION == -1) {
     computeUserPosition();
    }
    drawHighScores();
  }

  function setHighScore() {
    if (SCORE == 0)
      return;
    userHighScore = {};
    userHighScore.score = SCORE;
    userHighScore.username = USERNAME;
    userHighScore.avatar = AVATAR;
    HIGH_SCORES.setUserItem(userHighScore);
    post.save();
  }

  function isSuccess(){
    var i = 0;
    var reference = MAP[0][0];
    while (i < 8) {
      var j = 0;
      while (j < 8) {
        if (MAP[i][j] != reference) {
          return false;
        }
        ++j;
      }
      ++i;
    }
    return true;
  }

  function renderCircle(x, y) {
    ctx.globalAlpha = 0.3;
    ctx.beginPath();
    ctx.arc(x * 80 + 40, y * 80 + 40, 20, 0, 2 * Math.PI, false);
    ctx.fill();
    ctx.globalAlpha = 0.8;
    ctx.lineWidth = 2;
    ctx.stroke();
  }

  function renderGUI(){
    if (SELECTED.d) {
      // selected arc
     

      var c = document.createElement('canvas');
      c.width = 80;
      c.height = 80;
      var t = c.getContext('2d');
      t.drawImage(PAINT, 0,0);
      t.globalCompositeOperation = 'xor';
      t.fillStyle = MAP[SELECTED.x][SELECTED.y];
      t.fillRect(0,0,80,80);

      ctx.drawImage(c, (SELECTED.x - 1) * 80, SELECTED.y * 80);
      ctx.drawImage(c, (SELECTED.x + 1) * 80, SELECTED.y * 80);
      ctx.drawImage(c, SELECTED.x* 80, (SELECTED.y - 1) * 80);
      ctx.drawImage(c, SELECTED.x* 80, (SELECTED.y + 1) * 80);
    }
  }

  function contaminate(targetX, targetY, sourceX, sourceY) {
  	TARGET_COLOR = MAP[targetX][targetY];
  	NEW_COLOR = MAP[sourceX][sourceY];
    if (TARGET_COLOR != NEW_COLOR) {
      SCORE++;
      document.getElementById('uscore').innerHTML = SCORE;
      recursiveContamination(targetX, targetY);
    }

    if (isSuccess()) {
      renderGameOver();
    }
  }


  function recursiveContamination(x, y) {

    PARTICLES.push(
      {
        x : x * 80,
        y : y * 80,
        c : MAP[x][y],
        n : NEW_COLOR,
        s : 0
      });

    MAP[x][y] = NEW_COLOR;
  	if (x > 0 && MAP[x - 1][y] == TARGET_COLOR) {
  		recursiveContamination(x -1, y);
  	}
  	if (x < 7 && MAP[x + 1][y] == TARGET_COLOR) {
  		recursiveContamination(x + 1, y)
  	}
  	if (y > 0 && MAP[x][y - 1] == TARGET_COLOR) {
  		recursiveContamination(x, y - 1);
  	}
  	if (y < 7 && MAP[x][y + 1] == TARGET_COLOR) {
  		recursiveContamination(x, y + 1);
  	}
  }

  // Render loop

  window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
  })();
  
  function renderParticles() {
    var i = 0;
    while (i < PARTICLES.length) {
      var p = PARTICLES[i];

      p.s += 5;
     
      if (p.s == 100) {
        ctx.fillStyle = p.n;
        ctx.fillRect(p.x, p.y, 80, 80);
        PARTICLES.splice(i, 1);
        --i;
      }
      else {

        ctx.fillStyle = p.c;
        ctx.fillRect(p.x , p.y, 80, 80);
        ctx.globalAlpha = p.s / 100;
        ctx.fillStyle = p.n;
        ctx.fillRect(p.x , p.y, 80, 80);
        ctx.globalAlpha = 1.0;
      }
      ++i;

    }
  }

  function loop() {
    if (PARTICLES.length) {
      renderParticles();
    }
    requestAnimFrame(loop);
  }

  loop();

</script>